# Context

This document captures the current project focus, recent updates, and concrete next steps. It is fact-based and updated frequently.

Related docs:
- Brief: [`brief.md`](.agents/rules/memory-bank/brief.md)
- Product: [`product.md`](.agents/rules/memory-bank/product.md)
- Architecture: [`architecture.md`](.agents/rules/memory-bank/architecture.md)
- Tech: [`tech.md`](.agents/rules/memory-bank/tech.md)
- Tasks: [`tasks.md`](.agents/rules/memory-bank/tasks.md)

## Current Focus

- Adopt Go 1.24.6+, PostgreSQL 17, and Valkey 8 (replace Redis; rename REDIS_URL to VALKEY_URL)
- Update Memory Bank to codify conventions:
  - All SQL migrations and query files are placed only under [`db/migrations/`](db/migrations/) and [`db/queries/`](db/queries/) respectively.
  - Database configuration uses canonical DB_* environment variables; [`DATABASE_URL`](.env.example) is deprecated.
  - Configuration precedence and fallbacks:
    - Database: Prefer DB_*; if not set, accept DB_URL; if both present, DB_* take precedence.
    - Cache: Prefer VALKEY_*; if not set, accept VALKEY_URL; if both present, VALKEY_* take precedence; REDIS_URL is deprecated.
  - Each domain provides its own mocks under [`internal/domains/<domain>/mocks`](internal/domains/) generated via go.uber.org/mock/mockgen; DB-layer tests use DATA-DOG/go-sqlmock.

## Current Focus
- Revise code structure for simplicity and SOLID-driven clean architecture to improve maintainability and extensibility.

## Repository Snapshot

- Module: see [`go.mod`](go.mod)
- Key runtime entries:
  - Server: [`cmd/server/main.go`](cmd/server/main.go)
  - Migration runner: [`cmd/migrate/main.go`](cmd/migrate/main.go)
- Infrastructure and domains:
  - Config: [`internal/infrastructure/config/config.go`](internal/infrastructure/config/config.go)
  - Database: [`internal/infrastructure/database/database.go`](internal/infrastructure/database/database.go)
  - Generated query code: [`internal/infrastructure/database/queries`](internal/infrastructure/database/queries)
  - Domains: [`internal/domains/auth`](internal/domains/auth) and [`internal/domains/posts`](internal/domains/posts)
- SQL locations (current state):
  - Canonical: [`db/migrations/`](db/migrations/)
  - Legacy to deprecate: [`migrations/`](migrations/), [`internal/queries`](internal/queries), and any stray SQL under infra
- Environment example currently includes [`DATABASE_URL`](.env.example)

Notes:
- Align local toolchain with Go version declared in [`go.mod`](go.mod).

## Recent Updates
- All previously defined "Next Steps (Prioritized)" up to "Update domain tests to rely on mocks and go-sqlmock" have been completed.
- Architecture updated to codify db layout and domain mocks:
  - [`architecture.md`](.agents/rules/memory-bank/architecture.md)
- Tech updated to adopt DB_* env vars, deprecate DATABASE_URL, and set db/* paths:
  - [`tech.md`](.agents/rules/memory-bank/tech.md)
- Tasks updated for workflows covering db/*, DB_* vars, and mock generation:
  - [`tasks.md`](.agents/rules/memory-bank/tasks.md)
- Stack versions updated:
  - Go 1.24.6+, PostgreSQL 17, Valkey 8 replacing Redis; REDIS_URL deprecated in favor of VALKEY_URL
- Domain testing implemented:
  - Auth and posts domain usecase tests updated to use go.uber.org/mock/gomock exclusively
  - Generated mocks available under each domain's `mocks/` package  
  - All tests now run with full isolation from database dependencies
  - Comprehensive test coverage for all usecase methods including error scenarios


## Decisions

- Database environment variables (canonical):
  - DB_HOST, DB_PORT, DB_USER, DB_PASSWORD, DB_NAME, DB_SCHEMA, DB_SSLMODE
  - DATABASE_URL is deprecated; construct DSNs from DB_* at runtime for tools as needed.
- Configuration precedence and fallbacks:
  - Database: Prefer DB_*; if DB_* are not present, accept DB_URL; if both are present, DB_* take precedence.
  - Cache: Prefer VALKEY_* (VALKEY_HOST, VALKEY_PORT, VALKEY_PASSWORD, VALKEY_DB); if not present, accept VALKEY_URL; if both are present, VALKEY_* take precedence. REDIS_URL is deprecated.
- SQL placement:
  - Migrations live only under [`db/migrations`](db/migrations/)
  - Queries for sqlc live only under [`db/queries`](db/queries/)
- Domain mocks:
  - Per-domain mocks live under [`internal/domains/<domain>/mocks`](internal/domains/)
  - Generated by go.uber.org/mock/mockgen from repository interfaces
  - DB-layer tests use DATA-DOG/go-sqlmock; no real DB is required for unit tests
- Supported versions:
  - Go 1.24.6+ (align [go.mod](go.mod:1) accordingly)
  - PostgreSQL 17
- Cache layer:
  - Use Valkey v8 (Redis-compatible) for caching, rate limiting, and session/ephemeral state
  - Environment variables: VALKEY_* or VALKEY_URL; REDIS_URL is deprecated
## Divergences from prior state

- Legacy paths exist and must be refactored:
  - Top-level [`migrations/`](migrations/) → moved into [`db/migrations/`](db/migrations/) (Completed)
  - [`internal/queries`](internal/queries) and any stray SQL → consolidated into [`db/queries/`](db/queries/) (Completed)
- Environment example:
  - [`.env.example`](.env.example) currently uses DATABASE_URL; will be migrated to DB_* variables (Completed)
  - [`.env.example`](.env.example) currently uses REDIS_URL; will be migrated to VALKEY_URL (Completed)


## Next Steps (Prioritized)

All previous next steps have been addressed, including:

1. ✅ Update domain tests to rely on mocks and `go-sqlmock` (Completed)
2. ⬜ Revise code structure for simplicity and SOLID-driven clean architecture (Pending)

The project now has comprehensive test coverage with proper isolation.

## Follow-up Implementation Plan

- Update .env.example:
  - Replace DATABASE_URL with DB_* keys; provide a reference DSN construction snippet in docs (Completed)
- Refactor SQL locations:
  - Move and rename as necessary; search and replace imports/usages in code generation and build scripts (Completed)
- Update configuration loader:
  - Bind DB_* via Viper; construct and expose DSN for clients that need URL form (Completed)
- Regenerate sqlc:
  - Point to [`db/queries`](db/queries); verify generated code continues under [`internal/infrastructure/database/queries`](internal/infrastructure/database/queries) (Completed)
- Validate pipelines:
  - Run migrations locally and in CI using constructed MIGRATE_URL (Completed)
  - Run unit tests with mocks and sqlmock; ensure no hard dependency on real DB (Completed)

## Risks

- Refactor touches multiple systems (sqlc, migrate CLI, config loader); sequence changes carefully to keep builds green
- Ensure all references to legacy paths are removed to prevent drift